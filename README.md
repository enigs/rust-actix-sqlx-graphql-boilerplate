# GraphQL Server
Rust graphql server. Tech stack are as follows:
- [x] Rust `1.73.0`
    - [x] Actix Web
    - [x] Async Graphql
    - [x] Sqlx (install `sqlx-cli`)
    - [x] SSE enabled
    - [x] Websocket enabled
- [x] Postgres `15.3.4` with `Postgis` plugin enabled
- [x] Autometrics enabled (telemetry)
    - [x] Prometheus
    - [x] Grafana (dashboard) w/ autometrics dashboard enabled (just ask me for the setup)
- [x] Include generation of this boilerplate code under my personal generator cli.
  -  **Status:** Ongoing as of 11/16/2023
  -  **Status:** Completed as of 11/17/2023 - [https://github.com/enigs/gen](https://github.com/enigs/gen)

## Database:
```shell
docker run --restart unless-stopped -d --name $container_name \ 
-p $your_port:5432 \
--env POSTGRES_DB=$your_db_name \
--env POSTGRES_USER=$your_db_user \ 
--env POSTGRES_PASSWORD=$your_db_password \ 
--volume $_your_database_folder_path:/var/lib/postgresql/data \ 
postgis/postgis:15-3.4
```

## Development
1. Make sure to have the following installed
    - Latest **Rust** version (stable)
    - Running **PostgreSQL** instance w/ postgis.
        - **Note:** If you're not planning on using coordinates then modify the migration script under `assets/migrations/001_base.sql` and remove extensions for postgis and fuzzystrmatch.
    - **SQLx CLI** - [https://crates.io/crates/sqlx-cli](https://crates.io/crates/sqlx-cli). Install w/ postgres feature enabled.
    - **NodeJs (npm)** - This one is optional. I only made this in order to run the server with different configurations.
    - **Cargo Watch** - [https://crates.io/crates/cargo-watch](https://crates.io/crates/cargo-watch). This is optional as well. I only use this to run the server in development mode.
    - **Environment Variables** - This is necessary for the server to run. These are the required env variables:
        - `DATABASE_URL` - only required when running sqlx via cli and generating compiled queries (if you're using sqlx query macro).
        - `DATABASE_READ_URL` & `DATABASE_WRITE_URL` - postgre's node urls. You can just copy what's inside `DATABASE_URL` if you don't have any read/write replicas.
        - `APP_NAME` - Make sure to include this in your env file. `backend/config/mod.rs` is using the value of app name within our paseto token generation and authentication.
        - `MASTER_KEY` - Ask me on how to generate this. This should be partnered with a bearer token for controller specific configuration.
        - `TRACING_LEVEL` - This one is optional. You can choose between `debug`, `info`, `warn`, `error` or `off`. This is only used for tracing logs.
2. Parts of the workspace
    1. `.sqlx` - This folder will contain all of the compiled queries. This is generated by `sqlx-cli` and is used by the server to run queries.
    2. `assets` - This folder contains all resources such as locales, migration scripts, sample resources, static files and templates.
    3. `backend` - This is where the server is located. This is where you'll be spending most of your time.
        1. `config` - This is where the server configuration is located. Most static configuration declaration resides here
        2. `model` - This is where the models are located. This is where you'll be declaring your database models.
        3. `resolver` - This is where the resolvers are located. This is where you'll be declaring your graphql resolvers.
        4. `server` - This is where the server is located. This is where you'll be declaring your routes, middlewares, etc.
    4. `library` - This is where the library is located. This is where you'll be declaring your custom libraries.
    5. `macros` - This is where the macros are located. This is where you'll be declaring your custom macros.
3. Documentation
    1. Run the server and go to `http://localhost:9020/public` endpoint. You can go to `backend/config/mod.rs` if you want to change the port.

## How To:
You can run the following commands (if you have a nodejs installation)
- `npm run clippy`: Checks for clippy warnings & errors.
- `npm run dev`: Runs the server in development mode using cargo watch.
    - Make sure to install `cargo-watch` plugin.
- `npm run sqlx`: This will compile any sqlx macro invocations.
- `npm run sse-benchmark`: Run test for SSE connections.

## Notes:
- Further customization is currently in progress but this might be contained within the company releases. This is just a basic boilerplate code I'll be using for code generation for my generator cli.
- I prefer this over diesel or any other ORM because I can avoid most of the problems brought about by ORM's such as attribute creep, overhead with queries etc.
- Docker build for this image is only around 20-ish MB compressed unlike with diesel that requires so much additional dependencies for its container (compressed size is mostly around 900 MB - 1.x GB).

## Updates: 

### 11/16/2023:
1. Added main `Cargo.toml` file (I forgot to include this one before).
2. Added scheduler library using actix's actor system. Initialization is under `backend/server/src/main.rs` and the scheduler is under `library/src/scheduler/mod.rs`.

### 11/17/2023:
1. Completed cli tool helper to generate this base boilerplate code. You can check this repo [https://github.com/enigs/gen](https://github.com/enigs/gen) for more information.